<!DOCTYPE html>
<html>
<head>
    <title>Image Gallery - HydeHome-AllSky</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>HydeHome-AllSky - Image Gallery</h1>
                <nav>
            <ul>
                <li><a href="{{ url_for('index') }}">Latest</a></li>
                <li><a href="{{ url_for('gallery') }}">Gallery</a></li>
                <li><a href="{{ url_for('control_panel') }}">Control Panel</a></li>
                <li><a href="{{ url_for('system_status') }}">System Status</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="container">
            <div class="gallery-controls">
                <div class="search-filter">
                    <input type="text" id="searchInput" placeholder="Search by filename...">
                </div>
                <div class="sort-filter">
                    <label for="sortOption">Sort by:</label>
                    <select id="sortOption">
                        <option value="date-desc">Date (Newest First)</option>
                        <option value="date-asc">Date (Oldest First)</option>
                        <option value="exposure-desc">Exposure (Highest First)</option>
                        <option value="exposure-asc">Exposure (Lowest First)</option>
                    </select>
                </div>
            </div>

            <!-- Deletion Controls -->
            <div class="deletion-controls">
                <div class="deletion-header">
                    <h3>Delete Images</h3>
                    <button id="toggleDeletionMode" class="secondary-button">Enable Deletion Mode</button>
                </div>
                <div id="deletionPanel" class="deletion-panel hidden">
                    <div class="deletion-info">
                        <p>Select days to delete (latest image will always be preserved)</p>
                    </div>
                    <div class="deletion-buttons">
                        <button id="selectAllDays" class="button">Select All Days</button>
                        <button id="deselectAllDays" class="button secondary-button">Deselect All</button>
                        <button id="deleteSelected" class="button danger-button">Delete Selected</button>
                    </div>
                    <div id="deletionStatus" class="deletion-status"></div>
                </div>
            </div>

            <!-- FTP/sFTP Transfer -->
            <div class="deletion-controls">
                <div class="deletion-header">
                    <h3>FTP/sFTP Transfer</h3>
                    <button id="sftpTransferButton" class="secondary-button">Transfer All Images</button>
                </div>
                <div id="sftpTransferStatus" class="deletion-status" style="margin-top: 10px;"></div>
            </div>

            {% if images %}
            <div class="gallery-by-day">
                {% set night_groups = {} %}

                <!-- Group images by night session -->
                {% for image in images %}
                {% set night_label = image.night_session_label if image.night_session_label else 'Unknown Date' %}
                {% if night_label not in night_groups %}
                {% set _ = night_groups.update({night_label: []}) %}
                {% endif %}
                {% set _ = night_groups[night_label].append(image) %}
                {% endfor %}

                <!-- Display each night session as a collapsible section -->
                {% for night_label, night_images in night_groups|dictsort(reverse=True) %}
                <div class="day-section" data-day="{{ night_label }}" data-image-count="{{ night_images|length }}">
                    <div class="day-header" onclick="toggleDaySection(this)">
                        <div class="day-header-content">
                            <input type="checkbox" class="day-checkbox" data-day="{{ night_label }}" onclick="event.stopPropagation()" style="display: none;">
                            <h2>{{ night_label }} <span class="image-count">({{ night_images|length }} images)</span></h2>
                        </div>
                        <span class="toggle-icon">â–¼</span>
                    </div>

                    <div class="day-content">
                        <div class="gallery-grid">
                            {% for image in night_images %}
                            <div class="gallery-item" data-filename="{{ image.filename }}"
                                 data-timestamp="{{ image.timestamp or '' }}"
                                 data-exposure="{{ image.exposure_ms or '' }}">
                                <a href="{{ url_for('image_detail', filename=image.filename) }}">
                                    <div class="thumbnail">
                                        <img src="{{ url_for('serve_image', filename=image.filename) }}" alt="{{ image.filename }}">
                                    </div>
                                    <div class="image-info">
                                        <div class="filename">{{ image.filename }}</div>
                                        {% if image.timestamp %}
                                        <div class="capture-time">{{ image.timestamp.split(' ')[1] if ' ' in image.timestamp else '' }}</div>
                                        {% endif %}
                                        {% if image.exposure_ms %}
                                        <div class="exposure">{{ image.exposure_ms }} ms</div>
                                        {% endif %}
                                    </div>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-images">
                <p>No images found in the directory.</p>
                <a href="{{ url_for('control_panel') }}" class="button">Capture an Image</a>
            </div>
            {% endif %}
        </div>
    </main>

    <footer>
        <p>HydeHome-AllSky Web Interface</p>
    </footer>

    <script src="{{ url_for('static', filename='js/gallery.js') }}"></script>
</body>
</html>